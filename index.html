<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>æ™‚é–“è¨˜éŒ²ãƒ„ãƒ¼ãƒ«</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#e53935">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="è¨˜éŒ²">

  <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­– -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, #f0f4ff, #ffffff);
      margin: 0;
      padding: 20px;
      color: #333;
    }

    body.dark {
      background: #121212;
      color: #f1f1f1;
    }

    .app {
      max-width: 420px;
      margin: auto;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 16px rgba(0,0,0,.1);
    }

    body.dark .card {
      background: #1e1e1e;
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
    }

    button {
      background: blue;
      color: white;
      font-weight: bold;
    }

    .result {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      font-weight: bold;
      text-align: center;
    }

    .good { background: #dff5e6; color: #1b7f4d; }
    .warn { background: #fff3cd; color: #856404; }
    .bad  { background: #fde2e2; color: #842029; }

    ul { padding-left: 20px; }
    canvas { max-width: 100%; }
  </style>
</head>

<body>

<button id="toggleDark">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>

<div class="app">
  <div class="card">
    <h2>æ™‚é–“è¨˜éŒ²ãƒ„ãƒ¼ãƒ«</h2>

    <input type="number" id="numberInput" placeholder="æ™‚é–“ã‚’å…¥åŠ›">

    <button id="calcBtn">è¨˜éŒ²</button>
    <button id="resetBtn">ä»Šæœˆãƒªã‚»ãƒƒãƒˆ</button>

    <p id="totalTime">ä»Šæœˆã®ç´¯ç©ï¼š0</p>
    <select id="monthSelect"></select>

    <button id="mailBtn">ğŸ“© ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡</button>

    <div id="message" class="result"></div>
  </div>

  <h3>æ—¥ã”ã¨ã®è¨˜éŒ²</h3>
  <ul id="list"></ul>

  <canvas id="chart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- æœˆã‚­ãƒ¼ ---------- */
function monthKey() {
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}`;
}

let allData = JSON.parse(localStorage.getItem("allData")) || {};
if (!allData[monthKey()]) allData[monthKey()] = { total: 0, records: {} };

let monthlyTotal = allData[monthKey()].total;
let records = allData[monthKey()].records;

document.getElementById("totalTime").innerText = `ä»Šæœˆã®ç´¯ç©ï¼š${monthlyTotal}`;

/* ---------- æ—¥ä»˜ ---------- */
function todayKey() {
  const d = new Date();
  return `${d.getMonth()+1}/${d.getDate()}`;
}

// ----------æœˆä¸€è¦§----------
function updateMonthSelect() {
  const select = document.getElementById("monthSelect");
  select.innerHTML = "";

  Object.keys(allData).sort().forEach(key => {
    const option = document.createElement("option");
    option.value = key;
    option.textContent = key;
    if (key === monthKey()) option.selected = true;
    select.appendChild(option);
  });
}




/* ---------- ä¸€è¦§ ---------- */
function showList() {
  const ul = document.getElementById("list");
  ul.innerHTML = "";
  Object.keys(records).forEach(d => {
    const li = document.createElement("li");
    li.textContent = `${d}ï¼š${records[d]}`;
    ul.appendChild(li);
  });
}

/* ---------- ã‚°ãƒ©ãƒ• ---------- */
let chart;
function updateChart() {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "bar",
    data: {
      labels: Object.keys(records),
      datasets: [{
        data: Object.values(records),
        backgroundColor: "blue"
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });
}

/* ---------- è¨˜éŒ² ---------- */
document.getElementById("calcBtn").onclick = () => {
  const v = Number(numberInput.value);
  if (!v) return;

  monthlyTotal += v;
  records[todayKey()] = (records[todayKey()] || 0) + v;

  allData[monthKey()] = { total: monthlyTotal, records };
  localStorage.setItem("allData", JSON.stringify(allData));

  const day = new Date().getDate();
  const result = monthlyTotal / day;

  const msg = document.getElementById("message");
  msg.className = "result";

  if (result >= 2) {
    msg.classList.add("good");
    msg.textContent = "ãã‚Œã‚ˆã‚Šã‚‚ï¼Œç‰‡æ‰‹ã¯ä¼‘æ¯ã§æº€ãŸã™æ–¹ãŒã‚ˆã„ï¼ˆä¼é“ã®æ›¸4:6ï¼‰";
  } else if (result >= 1.6) {
    msg.classList.add("warn");
    msg.textContent = "æ™‚é–“ã‚’æœ‰åŠ¹ã«ä½¿ã£ã¦ãã ã•ã„ã€‚ä»Šã¯æ‚ªã„æ™‚ä»£ã ã‹ã‚‰ã§ã™ã€‚ï¼ˆã‚¨ãƒ•ã‚§ã‚½ã‚¹5:16ï¼‰";
  } else {
    msg.classList.add("bad");
    msg.textContent = "å‹¤å‹‰ãªäººã®è¨ˆç”»ã¯å¿…ãšæˆåŠŸã«ã¤ãªãŒã‚Šã€ã›ã£ã‹ã¡ãªäººã¯å¿…ãšè²§ä¹ã¸ã¨å‘ã‹ã†ï¼ˆæ ¼è¨€2:5ï¼‰";
  }

  document.getElementById("totalTime").innerText = `ä»Šæœˆã®ç´¯ç©ï¼š${monthlyTotal}`;
  numberInput.value = "";

  showList();
  updateChart();
};

/* ---------- ãƒªã‚»ãƒƒãƒˆ ---------- */
resetBtn.onclick = () => {
  allData[monthKey()] = { total: 0, records: {} };
  localStorage.setItem("allData", JSON.stringify(allData));
  location.reload();
};

/* ---------- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ---------- */
toggleDark.onclick = () => document.body.classList.toggle("dark");

/* ---------- ãƒ¡ãƒ¼ãƒ« ---------- */
mailBtn.onclick = () => {
  const m = new Date().getMonth()+1;
  const body =
`ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
${m}æœˆã®é‡å¤–å¥‰ä»•å ±å‘Šã§ã™
æ™‚é–“ï¼š${monthlyTotal}
ç ”ç©¶ï¼š

ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚`;

  location.href = `mailto:?subject=${encodeURIComponent("é‡å¤–å¥‰ä»•å ±å‘Š")}&body=${encodeURIComponent(body)}`;
};

showList();
updateChart();
updateMonthSelect();

// å±¥æ­´ã‚’è¡¨ç¤º
document.getElementById("monthSelect").addEventListener("change", e => {
  const selected = e.target.value;

  monthlyTotal = allData[selected].total;
  records = allData[selected].records;

  document.getElementById("totalTime").innerText =
    `ä»Šæœˆã®ç´¯ç©ï¼š${monthlyTotal}`;

  showList();
  updateChart();
});

</script>

</body>
</html>
